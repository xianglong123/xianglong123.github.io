(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{790:function(n,s,e){"use strict";e.r(s);var a=e(0),t=Object(a.a)({},(function(){var n=this,s=n._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("h1",{attrs:{id:"juc锁-锁核心类aqs详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#juc锁-锁核心类aqs详解"}},[n._v("#")]),n._v(" JUC锁:锁核心类AQS详解")]),n._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[n._v("提示")]),n._v(" "),s("p",[n._v("AbstractQueuedSynchronizer抽象类是核心，需要重点掌握。它提供了一个基于FIFO队列，可以用于构建锁或者其他相关同步装置的基础框架。 @123")])]),n._v(" "),s("ul",[s("li",[n._v("JUC锁: 锁核心类AQS详解\n"),s("ul",[s("li",[n._v("带着BAT大厂的面试问题去理解")]),n._v(" "),s("li",[n._v("AbstractQueuedSynchronizer简介\n"),s("ul",[s("li",[n._v("AQS 核心思想")]),n._v(" "),s("li",[n._v("AQS 对资源的共享方式")]),n._v(" "),s("li",[n._v("AQS底层使用了模板方法模式")])])]),n._v(" "),s("li",[n._v("AbstractQueuedSynchronizer数据结构")]),n._v(" "),s("li",[n._v("AbstractQueuedSynchronizer源码分析\n"),s("ul",[s("li",[n._v("类的继承关系")]),n._v(" "),s("li",[n._v("类的内部类 - Node类")]),n._v(" "),s("li",[n._v("类的内部类 - ConditionObject类")]),n._v(" "),s("li",[n._v("类的属性")]),n._v(" "),s("li",[n._v("类的构造方法")]),n._v(" "),s("li",[n._v("类的核心方法 - acquire方法")]),n._v(" "),s("li",[n._v("类的核心方法 - release方法")])])]),n._v(" "),s("li",[n._v("AbstractQueuedSynchronizer示例详解一")]),n._v(" "),s("li",[n._v("AbstractQueuedSynchronizer示例详解二")]),n._v(" "),s("li",[n._v("AbstractQueuedSynchronizer总结")]),n._v(" "),s("li",[n._v("参考文章")])])])]),n._v(" "),s("h3",{attrs:{id:"带着bat大厂的面试问题去理解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#带着bat大厂的面试问题去理解"}},[n._v("#")]),n._v(" # 带着BAT大厂的面试问题去理解")]),n._v(" "),s("blockquote",[s("p",[n._v("提示")])]),n._v(" "),s("blockquote",[s("p",[n._v("请带着这些问题继续后文，会很大程度上帮助你更好的理解相关知识点。@123")])]),n._v(" "),s("ul",[s("li",[s("p",[n._v("什么是AQS? 为什么它是核心?")])]),n._v(" "),s("li",[s("p",[n._v("AQS的核心思想是什么? 它是怎么实现的? 底层数据结构等")])]),n._v(" "),s("li",[s("p",[n._v("AQS有哪些核心的方法?")])]),n._v(" "),s("li",[s("p",[n._v("AQS定义什么样的资源获取方式? AQS定义了两种资源获取方式："),s("code",[n._v("独占")]),n._v("(只有一个线程能访问执行，又根据是否按队列的顺序分为"),s("code",[n._v("公平锁")]),n._v("和"),s("code",[n._v("非公平锁")]),n._v("，如"),s("code",[n._v("ReentrantLock")]),n._v(") 和"),s("code",[n._v("共享")]),n._v("(多个线程可同时访问执行，如"),s("code",[n._v("Semaphore")]),n._v("、"),s("code",[n._v("CountDownLatch")]),n._v("、 "),s("code",[n._v("CyclicBarrier")]),n._v(" )。")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("ReentrantReadWriteLock\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("可以看成是组合式，允许多个线程同时对某一资源进行读。")])]),n._v(" "),s("li",[s("p",[n._v("AQS底层使用了什么样的设计模式? 模板")])]),n._v(" "),s("li",[s("p",[n._v("AQS的应用示例?")])])]),n._v(" "),s("h3",{attrs:{id:"abstractqueuedsynchronizer简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#abstractqueuedsynchronizer简介"}},[n._v("#")]),n._v(" # AbstractQueuedSynchronizer简介")]),n._v(" "),s("blockquote",[s("p",[n._v("AQS是一个用来构建锁和同步器的框架，使用AQS能简单且高效地构造出应用广泛的大量的同步器，比如我们提到的ReentrantLock，Semaphore，其他的诸如ReentrantReadWriteLock，SynchronousQueue，FutureTask等等皆是基于AQS的。当然，我们自己也能利用AQS非常轻松容易地构造出符合我们自己需求的同步器。")])]),n._v(" "),s("h3",{attrs:{id:"aqs-核心思想"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aqs-核心思想"}},[n._v("#")]),n._v(" # AQS 核心思想")]),n._v(" "),s("blockquote",[s("p",[n._v("AQS核心思想是，如果被请求的共享资源空闲，则将当前请求资源的线程设置为有效的工作线程，并且将共享资源设置为锁定状态。如果被请求的共享资源被占用，那么就需要一套线程阻塞等待以及被唤醒时锁分配的机制，这个机制AQS是用CLH队列锁实现的，即将暂时获取不到锁的线程加入到队列中。")])]),n._v(" "),s("blockquote",[s("blockquote",[s("p",[n._v("CLH(Craig,Landin,and Hagersten)队列是一个虚拟的双向队列(虚拟的双向队列即不存在队列实例，仅存在结点之间的关联关系)。AQS是将每条请求共享资源的线程封装成一个CLH锁队列的一个结点(Node)来实现锁的分配。")])])]),n._v(" "),s("blockquote",[s("p",[n._v("AQS使用一个int成员变量来表示同步状态，通过内置的FIFO队列来完成获取资源线程的排队工作。AQS使用CAS对该同步状态进行原子操作实现对其值的修改。")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("private volatile int state;//共享变量，使用volatile修饰保证线程可见性\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("blockquote",[s("p",[n._v("状态信息通过procted类型的getState，setState，compareAndSetState进行操作")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("//返回同步状态的当前值\nprotected final int getState() {  \n        return state;\n}\n // 设置同步状态的值\nprotected final void setState(int newState) { \n        state = newState;\n}\n//原子地(CAS操作)将同步状态值设置为给定值update如果当前同步状态的值等于expect(期望值)\nprotected final boolean compareAndSetState(int expect, int update) {\n        return unsafe.compareAndSwapInt(this, stateOffset, expect, update);\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br")])]),s("h3",{attrs:{id:"aqs-对资源的共享方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aqs-对资源的共享方式"}},[n._v("#")]),n._v(" # AQS 对资源的共享方式")]),n._v(" "),s("blockquote",[s("p",[n._v("AQS定义两种资源共享方式")])]),n._v(" "),s("ul",[s("li",[n._v("Exclusive(独占)：只有一个线程能执行，如ReentrantLock。又可分为公平锁和非公平锁：\n"),s("ul",[s("li",[n._v("公平锁：按照线程在队列中的排队顺序，先到者先拿到锁")]),n._v(" "),s("li",[n._v("非公平锁：当线程要获取锁时，无视队列顺序直接去抢锁，谁抢到就是谁的")])])]),n._v(" "),s("li",[n._v("Share(共享)：多个线程可同时执行，如Semaphore/CountDownLatch。Semaphore、CountDownLatCh、 CyclicBarrier、ReadWriteLock 我们都会在后面讲到。")])]),n._v(" "),s("blockquote",[s("p",[n._v("ReentrantReadWriteLock 可以看成是组合式，因为ReentrantReadWriteLock也就是读写锁允许多个线程同时对某一资源进行读。")])]),n._v(" "),s("blockquote",[s("p",[n._v("不同的自定义同步器争用共享资源的方式也不同。自定义同步器在实现时只需要实现共享资源 state 的获取与释放方式即可，至于具体线程等待队列的维护(如获取资源失败入队/唤醒出队等)，AQS已经在上层已经帮我们实现好了。")])]),n._v(" "),s("h3",{attrs:{id:"aqs底层使用了模板方法模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aqs底层使用了模板方法模式"}},[n._v("#")]),n._v(" # AQS底层使用了模板方法模式")]),n._v(" "),s("blockquote",[s("blockquote",[s("p",[n._v("同步器的设计是基于模板方法模式的，如果需要自定义同步器一般的方式是这样(模板方法模式很经典的一个应用)：")])])]),n._v(" "),s("blockquote",[s("p",[n._v("使用者继承AbstractQueuedSynchronizer并重写指定的方法。(这些重写方法很简单，无非是对于共享资源state的获取和释放) 将AQS组合在自定义同步组件的实现中，并调用其模板方法，而这些模板方法会调用使用者重写的方法。")])]),n._v(" "),s("blockquote",[s("p",[n._v("这和我们以往通过实现接口的方式有很大区别，模板方法模式请参看：设计模式行为型 - 模板方法(Template Method)详解")])]),n._v(" "),s("blockquote",[s("p",[n._v("AQS使用了模板方法模式，自定义同步器时需要重写下面几个AQS提供的模板方法：")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("isHeldExclusively()//该线程是否正在独占资源。只有用到condition才需要去实现它。\ntryAcquire(int)//独占方式。尝试获取资源，成功则返回true，失败则返回false。\ntryRelease(int)//独占方式。尝试释放资源，成功则返回true，失败则返回false。\ntryAcquireShared(int)//共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。\ntryReleaseShared(int)//共享方式。尝试释放资源，成功则返回true，失败则返回false。\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("blockquote",[s("p",[n._v("默认情况下，每个方法都抛出 UnsupportedOperationException。 这些方法的实现必须是内部线程安全的，并且通常应该简短而不是阻塞。AQS类中的其他方法都是final ，所以无法被其他类使用，只有这几个方法可以被其他类使用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("以ReentrantLock为例，state初始化为0，表示未锁定状态。A线程lock()时，会调用tryAcquire()独占该锁并将state+1。此后，其他线程再tryAcquire()时就会失败，直到A线程unlock()到state=0(即释放锁)为止，其它线程才有机会获取该锁。当然，释放锁之前，A线程自己是可以重复获取此锁的(state会累加)，这就是可重入的概念。但要注意，获取多少次就要释放多么次，这样才能保证state是能回到零态的。")])]),n._v(" "),s("h3",{attrs:{id:"abstractqueuedsynchronizer数据结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#abstractqueuedsynchronizer数据结构"}},[n._v("#")]),n._v(" # AbstractQueuedSynchronizer数据结构")]),n._v(" "),s("blockquote",[s("p",[n._v("AbstractQueuedSynchronizer类底层的数据结构是使用")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("CLH(Craig,Landin,and Hagersten)队列\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("是一个虚拟的双向队列(虚拟的双向队列即不存在队列实例，仅存在结点之间的关联关系)。AQS是将每条请求共享资源的线程封装成一个CLH锁队列的一个结点(Node)来实现锁的分配。其中Sync queue，即同步队列，是双向链表，包括head结点和tail结点，head结点主要用作后续的调度。而Condition queue不是必须的，其是一个单向链表，只有当使用Condition时，才会存在此单向链表。并且可能会有多个Condition queue。")]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-1.png)")])]),n._v(" "),s("h3",{attrs:{id:"abstractqueuedsynchronizer源码分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#abstractqueuedsynchronizer源码分析"}},[n._v("#")]),n._v(" # AbstractQueuedSynchronizer源码分析")]),n._v(" "),s("h3",{attrs:{id:"类的继承关系"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#类的继承关系"}},[n._v("#")]),n._v(" # 类的继承关系")]),n._v(" "),s("blockquote",[s("p",[n._v("AbstractQueuedSynchronizer继承自AbstractOwnableSynchronizer抽象类，并且实现了Serializable接口，可以进行序列化。")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer implements java.io.Serializable\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("blockquote",[s("p",[n._v("其中AbstractOwnableSynchronizer抽象类的源码如下:")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("public abstract class AbstractOwnableSynchronizer implements java.io.Serializable {\n\n    // 版本序列号\n    private static final long serialVersionUID = 3737899427754241961L;\n    // 构造方法\n    protected AbstractOwnableSynchronizer() { }\n    // 独占模式下的线程\n    private transient Thread exclusiveOwnerThread;\n\n    // 设置独占线程 \n    protected final void setExclusiveOwnerThread(Thread thread) {\n        exclusiveOwnerThread = thread;\n    }\n\n    // 获取独占线程 \n    protected final Thread getExclusiveOwnerThread() {\n        return exclusiveOwnerThread;\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br")])]),s("blockquote",[s("p",[n._v("AbstractOwnableSynchronizer抽象类中，可以设置独占资源线程和获取独占资源线程。分别为setExclusiveOwnerThread与getExclusiveOwnerThread方法，这两个方法会被子类调用。")])]),n._v(" "),s("blockquote",[s("blockquote",[s("p",[n._v("AbstractQueuedSynchronizer类有两个内部类，分别为Node类与ConditionObject类。下面分别做介绍。")])])]),n._v(" "),s("h3",{attrs:{id:"类的内部类-node类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#类的内部类-node类"}},[n._v("#")]),n._v(" # 类的内部类 - Node类")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("static final class Node {\n    // 模式，分为共享与独占\n    // 共享模式\n    static final Node SHARED = new Node();\n    // 独占模式\n    static final Node EXCLUSIVE = null;        \n    // 结点状态\n    // CANCELLED，值为1，表示当前的线程被取消\n    // SIGNAL，值为-1，表示当前节点的后继节点包含的线程需要运行，也就是unpark\n    // CONDITION，值为-2，表示当前节点在等待condition，也就是在condition队列中\n    // PROPAGATE，值为-3，表示当前场景下后续的acquireShared能够得以执行\n    // 值为0，表示当前节点在sync队列中，等待着获取锁\n    static final int CANCELLED =  1;\n    static final int SIGNAL    = -1;\n    static final int CONDITION = -2;\n    static final int PROPAGATE = -3;        \n\n    // 结点状态\n    volatile int waitStatus;        \n    // 前驱结点\n    volatile Node prev;    \n    // 后继结点\n    volatile Node next;        \n    // 结点所对应的线程\n    volatile Thread thread;        \n    // 下一个等待者\n    Node nextWaiter;\n\n    // 结点是否在共享模式下等待\n    final boolean isShared() {\n        return nextWaiter == SHARED;\n    }\n\n    // 获取前驱结点，若前驱结点为空，抛出异常\n    final Node predecessor() throws NullPointerException {\n        // 保存前驱结点\n        Node p = prev; \n        if (p == null) // 前驱结点为空，抛出异常\n            throw new NullPointerException();\n        else // 前驱结点不为空，返回\n            return p;\n    }\n\n    // 无参构造方法\n    Node() {    // Used to establish initial head or SHARED marker\n    }\n\n    // 构造方法\n        Node(Thread thread, Node mode) {    // Used by addWaiter\n        this.nextWaiter = mode;\n        this.thread = thread;\n    }\n\n    // 构造方法\n    Node(Thread thread, int waitStatus) { // Used by Condition\n        this.waitStatus = waitStatus;\n        this.thread = thread;\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br"),s("span",{staticClass:"line-number"},[n._v("59")]),s("br")])]),s("blockquote",[s("p",[n._v("每个线程被阻塞的线程都会被封装成一个Node结点，放入队列。每个节点包含了一个Thread类型的引用，并且每个节点都存在一个状态，具体状态如下。")])]),n._v(" "),s("ul",[s("li",[s("blockquote",[s("p",[s("code",[n._v("CANCELLED")]),n._v("，值为1，表示当前的线程被取消。")])])]),n._v(" "),s("li",[s("blockquote",[s("p",[s("code",[n._v("SIGNAL")]),n._v("，值为-1，表示当前节点的后继节点包含的线程需要运行，需要进行unpark操作。")])])]),n._v(" "),s("li",[s("blockquote",[s("p",[s("code",[n._v("CONDITION")]),n._v("，值为-2，表示当前节点在等待condition，也就是在condition queue中。")])])]),n._v(" "),s("li",[s("blockquote",[s("p",[s("code",[n._v("PROPAGATE")]),n._v("，值为-3，表示当前场景下后续的acquireShared能够得以执行。")])])]),n._v(" "),s("li",[s("blockquote",[s("p",[n._v("值为0，表示当前节点在sync queue中，等待着获取锁。")])])])]),n._v(" "),s("h3",{attrs:{id:"类的内部类-conditionobject类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#类的内部类-conditionobject类"}},[n._v("#")]),n._v(" # 类的内部类 - ConditionObject类")]),n._v(" "),s("blockquote",[s("p",[n._v("这个类有点长，耐心看下:")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("// 内部类\npublic class ConditionObject implements Condition, java.io.Serializable {\n    // 版本号\n    private static final long serialVersionUID = 1173984872572414699L;\n    /** First node of condition queue. */\n    // condition队列的头节点\n    private transient Node firstWaiter;\n    /** Last node of condition queue. */\n    // condition队列的尾结点\n    private transient Node lastWaiter;\n\n    /**\n        * Creates a new {@code ConditionObject} instance.\n        */\n    // 构造方法\n    public ConditionObject() { }\n\n    // Internal methods\n\n    /**\n        * Adds a new waiter to wait queue.\n        * @return its new wait node\n        */\n    // 添加新的waiter到wait队列\n    private Node addConditionWaiter() {\n        // 保存尾结点\n        Node t = lastWaiter;\n        // If lastWaiter is cancelled, clean out.\n        if (t != null && t.waitStatus != Node.CONDITION) { // 尾结点不为空，并且尾结点的状态不为CONDITION\n            // 清除状态为CONDITION的结点\n            unlinkCancelledWaiters(); \n            // 将最后一个结点重新赋值给t\n            t = lastWaiter;\n        }\n        // 新建一个结点\n        Node node = new Node(Thread.currentThread(), Node.CONDITION);\n        if (t == null) // 尾结点为空\n            // 设置condition队列的头节点\n            firstWaiter = node;\n        else // 尾结点不为空\n            // 设置为节点的nextWaiter域为node结点\n            t.nextWaiter = node;\n        // 更新condition队列的尾结点\n        lastWaiter = node;\n        return node;\n    }\n\n    /**\n        * Removes and transfers nodes until hit non-cancelled one or\n        * null. Split out from signal in part to encourage compilers\n        * to inline the case of no waiters.\n        * @param first (non-null) the first node on condition queue\n        */\n    private void doSignal(Node first) {\n        // 循环\n        do {\n            if ( (firstWaiter = first.nextWaiter) == null) // 该节点的nextWaiter为空\n                // 设置尾结点为空\n                lastWaiter = null;\n            // 设置first结点的nextWaiter域\n            first.nextWaiter = null;\n        } while (!transferForSignal(first) &&\n                    (first = firstWaiter) != null); // 将结点从condition队列转移到sync队列失败并且condition队列中的头节点不为空，一直循环\n    }\n\n    /**\n        * Removes and transfers all nodes.\n        * @param first (non-null) the first node on condition queue\n        */\n    private void doSignalAll(Node first) {\n        // condition队列的头节点尾结点都设置为空\n        lastWaiter = firstWaiter = null;\n        // 循环\n        do {\n            // 获取first结点的nextWaiter域结点\n            Node next = first.nextWaiter;\n            // 设置first结点的nextWaiter域为空\n            first.nextWaiter = null;\n            // 将first结点从condition队列转移到sync队列\n            transferForSignal(first);\n            // 重新设置first\n            first = next;\n        } while (first != null);\n    }\n\n    /**\n        * Unlinks cancelled waiter nodes from condition queue.\n        * Called only while holding lock. This is called when\n        * cancellation occurred during condition wait, and upon\n        * insertion of a new waiter when lastWaiter is seen to have\n        * been cancelled. This method is needed to avoid garbage\n        * retention in the absence of signals. So even though it may\n        * require a full traversal, it comes into play only when\n        * timeouts or cancellations occur in the absence of\n        * signals. It traverses all nodes rather than stopping at a\n        * particular target to unlink all pointers to garbage nodes\n        * without requiring many re-traversals during cancellation\n        * storms.\n        */\n    // 从condition队列中清除状态为CANCEL的结点\n    private void unlinkCancelledWaiters() {\n        // 保存condition队列头节点\n        Node t = firstWaiter;\n        Node trail = null;\n        while (t != null) { // t不为空\n            // 下一个结点\n            Node next = t.nextWaiter;\n            if (t.waitStatus != Node.CONDITION) { // t结点的状态不为CONDTION状态\n                // 设置t节点的nextWaiter域为空\n                t.nextWaiter = null;\n                if (trail == null) // trail为空\n                    // 重新设置condition队列的头节点\n                    firstWaiter = next;\n                else // trail不为空\n                    // 设置trail结点的nextWaiter域为next结点\n                    trail.nextWaiter = next;\n                if (next == null) // next结点为空\n                    // 设置condition队列的尾结点\n                    lastWaiter = trail;\n            }\n            else // t结点的状态为CONDTION状态\n                // 设置trail结点\n                trail = t;\n            // 设置t结点\n            t = next;\n        }\n    }\n\n    // public methods\n\n    /**\n        * Moves the longest-waiting thread, if one exists, from the\n        * wait queue for this condition to the wait queue for the\n        * owning lock.\n        *\n        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}\n        *         returns {@code false}\n        */\n    // 唤醒一个等待线程。如果所有的线程都在等待此条件，则选择其中的一个唤醒。在从 await 返回之前，该线程必须重新获取锁。\n    public final void signal() {\n        if (!isHeldExclusively()) // 不被当前线程独占，抛出异常\n            throw new IllegalMonitorStateException();\n        // 保存condition队列头节点\n        Node first = firstWaiter;\n        if (first != null) // 头节点不为空\n            // 唤醒一个等待线程\n            doSignal(first);\n    }\n\n    /**\n        * Moves all threads from the wait queue for this condition to\n        * the wait queue for the owning lock.\n        *\n        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}\n        *         returns {@code false}\n        */\n    // 唤醒所有等待线程。如果所有的线程都在等待此条件，则唤醒所有线程。在从 await 返回之前，每个线程都必须重新获取锁。\n    public final void signalAll() {\n        if (!isHeldExclusively()) // 不被当前线程独占，抛出异常\n            throw new IllegalMonitorStateException();\n        // 保存condition队列头节点\n        Node first = firstWaiter;\n        if (first != null) // 头节点不为空\n            // 唤醒所有等待线程\n            doSignalAll(first);\n    }\n\n    /**\n        * Implements uninterruptible condition wait.\n        * <ol>\n        * <li> Save lock state returned by {@link #getState}.\n        * <li> Invoke {@link #release} with saved state as argument,\n        *      throwing IllegalMonitorStateException if it fails.\n        * <li> Block until signalled.\n        * <li> Reacquire by invoking specialized version of\n        *      {@link #acquire} with saved state as argument.\n        * </ol>\n        */\n    // 等待，当前线程在接到信号之前一直处于等待状态，不响应中断\n    public final void awaitUninterruptibly() {\n        // 添加一个结点到等待队列\n        Node node = addConditionWaiter();\n        // 获取释放的状态\n        int savedState = fullyRelease(node);\n        boolean interrupted = false;\n        while (!isOnSyncQueue(node)) { // \n            // 阻塞当前线程\n            LockSupport.park(this);\n            if (Thread.interrupted()) // 当前线程被中断\n                // 设置interrupted状态\n                interrupted = true; \n        }\n        if (acquireQueued(node, savedState) || interrupted) // \n            selfInterrupt();\n    }\n\n    /*\n        * For interruptible waits, we need to track whether to throw\n        * InterruptedException, if interrupted while blocked on\n        * condition, versus reinterrupt current thread, if\n        * interrupted while blocked waiting to re-acquire.\n        */\n\n    /** Mode meaning to reinterrupt on exit from wait */\n    private static final int REINTERRUPT =  1;\n    /** Mode meaning to throw InterruptedException on exit from wait */\n    private static final int THROW_IE    = -1;\n\n    /**\n        * Checks for interrupt, returning THROW_IE if interrupted\n        * before signalled, REINTERRUPT if after signalled, or\n        * 0 if not interrupted.\n        */\n    private int checkInterruptWhileWaiting(Node node) {\n        return Thread.interrupted() ?\n            (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) :\n            0; \n    }\n\n    /**\n        * Throws InterruptedException, reinterrupts current thread, or\n        * does nothing, depending on mode.\n        */\n    private void reportInterruptAfterWait(int interruptMode)\n        throws InterruptedException {\n        if (interruptMode == THROW_IE)\n            throw new InterruptedException();\n        else if (interruptMode == REINTERRUPT)\n            selfInterrupt();\n    }\n\n    /**\n        * Implements interruptible condition wait.\n        * <ol>\n        * <li> If current thread is interrupted, throw InterruptedException.\n        * <li> Save lock state returned by {@link #getState}.\n        * <li> Invoke {@link #release} with saved state as argument,\n        *      throwing IllegalMonitorStateException if it fails.\n        * <li> Block until signalled or interrupted.\n        * <li> Reacquire by invoking specialized version of\n        *      {@link #acquire} with saved state as argument.\n        * <li> If interrupted while blocked in step 4, throw InterruptedException.\n        * </ol>\n        */\n    // // 等待，当前线程在接到信号或被中断之前一直处于等待状态\n    public final void await() throws InterruptedException {\n        if (Thread.interrupted()) // 当前线程被中断，抛出异常\n            throw new InterruptedException();\n        // 在wait队列上添加一个结点\n        Node node = addConditionWaiter();\n        // \n        int savedState = fullyRelease(node);\n        int interruptMode = 0;\n        while (!isOnSyncQueue(node)) {\n            // 阻塞当前线程\n            LockSupport.park(this);\n            if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) // 检查结点等待时的中断类型\n                break;\n        }\n        if (acquireQueued(node, savedState) && interruptMode != THROW_IE)\n            interruptMode = REINTERRUPT;\n        if (node.nextWaiter != null) // clean up if cancelled\n            unlinkCancelledWaiters();\n        if (interruptMode != 0)\n            reportInterruptAfterWait(interruptMode);\n    }\n\n    /**\n        * Implements timed condition wait.\n        * <ol>\n        * <li> If current thread is interrupted, throw InterruptedException.\n        * <li> Save lock state returned by {@link #getState}.\n        * <li> Invoke {@link #release} with saved state as argument,\n        *      throwing IllegalMonitorStateException if it fails.\n        * <li> Block until signalled, interrupted, or timed out.\n        * <li> Reacquire by invoking specialized version of\n        *      {@link #acquire} with saved state as argument.\n        * <li> If interrupted while blocked in step 4, throw InterruptedException.\n        * </ol>\n        */\n    // 等待，当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态 \n    public final long awaitNanos(long nanosTimeout)\n            throws InterruptedException {\n        if (Thread.interrupted())\n            throw new InterruptedException();\n        Node node = addConditionWaiter();\n        int savedState = fullyRelease(node);\n        final long deadline = System.nanoTime() + nanosTimeout;\n        int interruptMode = 0;\n        while (!isOnSyncQueue(node)) {\n            if (nanosTimeout <= 0L) {\n                transferAfterCancelledWait(node);\n                break;\n            }\n            if (nanosTimeout >= spinForTimeoutThreshold)\n                LockSupport.parkNanos(this, nanosTimeout);\n            if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)\n                break;\n            nanosTimeout = deadline - System.nanoTime();\n        }\n        if (acquireQueued(node, savedState) && interruptMode != THROW_IE)\n            interruptMode = REINTERRUPT;\n        if (node.nextWaiter != null)\n            unlinkCancelledWaiters();\n        if (interruptMode != 0)\n            reportInterruptAfterWait(interruptMode);\n        return deadline - System.nanoTime();\n    }\n\n    /**\n        * Implements absolute timed condition wait.\n        * <ol>\n        * <li> If current thread is interrupted, throw InterruptedException.\n        * <li> Save lock state returned by {@link #getState}.\n        * <li> Invoke {@link #release} with saved state as argument,\n        *      throwing IllegalMonitorStateException if it fails.\n        * <li> Block until signalled, interrupted, or timed out.\n        * <li> Reacquire by invoking specialized version of\n        *      {@link #acquire} with saved state as argument.\n        * <li> If interrupted while blocked in step 4, throw InterruptedException.\n        * <li> If timed out while blocked in step 4, return false, else true.\n        * </ol>\n        */\n    // 等待，当前线程在接到信号、被中断或到达指定最后期限之前一直处于等待状态\n    public final boolean awaitUntil(Date deadline)\n            throws InterruptedException {\n        long abstime = deadline.getTime();\n        if (Thread.interrupted())\n            throw new InterruptedException();\n        Node node = addConditionWaiter();\n        int savedState = fullyRelease(node);\n        boolean timedout = false;\n        int interruptMode = 0;\n        while (!isOnSyncQueue(node)) {\n            if (System.currentTimeMillis() > abstime) {\n                timedout = transferAfterCancelledWait(node);\n                break;\n            }\n            LockSupport.parkUntil(this, abstime);\n            if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)\n                break;\n        }\n        if (acquireQueued(node, savedState) && interruptMode != THROW_IE)\n            interruptMode = REINTERRUPT;\n        if (node.nextWaiter != null)\n            unlinkCancelledWaiters();\n        if (interruptMode != 0)\n            reportInterruptAfterWait(interruptMode);\n        return !timedout;\n    }\n\n    /**\n        * Implements timed condition wait.\n        * <ol>\n        * <li> If current thread is interrupted, throw InterruptedException.\n        * <li> Save lock state returned by {@link #getState}.\n        * <li> Invoke {@link #release} with saved state as argument,\n        *      throwing IllegalMonitorStateException if it fails.\n        * <li> Block until signalled, interrupted, or timed out.\n        * <li> Reacquire by invoking specialized version of\n        *      {@link #acquire} with saved state as argument.\n        * <li> If interrupted while blocked in step 4, throw InterruptedException.\n        * <li> If timed out while blocked in step 4, return false, else true.\n        * </ol>\n        */\n    // 等待，当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态。此方法在行为上等效于: awaitNanos(unit.toNanos(time)) > 0\n    public final boolean await(long time, TimeUnit unit)\n            throws InterruptedException {\n        long nanosTimeout = unit.toNanos(time);\n        if (Thread.interrupted())\n            throw new InterruptedException();\n        Node node = addConditionWaiter();\n        int savedState = fullyRelease(node);\n        final long deadline = System.nanoTime() + nanosTimeout;\n        boolean timedout = false;\n        int interruptMode = 0;\n        while (!isOnSyncQueue(node)) {\n            if (nanosTimeout <= 0L) {\n                timedout = transferAfterCancelledWait(node);\n                break;\n            }\n            if (nanosTimeout >= spinForTimeoutThreshold)\n                LockSupport.parkNanos(this, nanosTimeout);\n            if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)\n                break;\n            nanosTimeout = deadline - System.nanoTime();\n        }\n        if (acquireQueued(node, savedState) && interruptMode != THROW_IE)\n            interruptMode = REINTERRUPT;\n        if (node.nextWaiter != null)\n            unlinkCancelledWaiters();\n        if (interruptMode != 0)\n            reportInterruptAfterWait(interruptMode);\n        return !timedout;\n    }\n\n    //  support for instrumentation\n\n    /**\n        * Returns true if this condition was created by the given\n        * synchronization object.\n        *\n        * @return {@code true} if owned\n        */\n    final boolean isOwnedBy(AbstractQueuedSynchronizer sync) {\n        return sync == AbstractQueuedSynchronizer.this;\n    }\n\n    /**\n        * Queries whether any threads are waiting on this condition.\n        * Implements {@link AbstractQueuedSynchronizer#hasWaiters(ConditionObject)}.\n        *\n        * @return {@code true} if there are any waiting threads\n        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}\n        *         returns {@code false}\n        */\n    //  查询是否有正在等待此条件的任何线程\n    protected final boolean hasWaiters() {\n        if (!isHeldExclusively())\n            throw new IllegalMonitorStateException();\n        for (Node w = firstWaiter; w != null; w = w.nextWaiter) {\n            if (w.waitStatus == Node.CONDITION)\n                return true;\n        }\n        return false;\n    }\n\n    /**\n        * Returns an estimate of the number of threads waiting on\n        * this condition.\n        * Implements {@link AbstractQueuedSynchronizer#getWaitQueueLength(ConditionObject)}.\n        *\n        * @return the estimated number of waiting threads\n        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}\n        *         returns {@code false}\n        */\n    // 返回正在等待此条件的线程数估计值\n    protected final int getWaitQueueLength() {\n        if (!isHeldExclusively())\n            throw new IllegalMonitorStateException();\n        int n = 0;\n        for (Node w = firstWaiter; w != null; w = w.nextWaiter) {\n            if (w.waitStatus == Node.CONDITION)\n                ++n;\n        }\n        return n;\n    }\n\n    /**\n        * Returns a collection containing those threads that may be\n        * waiting on this Condition.\n        * Implements {@link AbstractQueuedSynchronizer#getWaitingThreads(ConditionObject)}.\n        *\n        * @return the collection of threads\n        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}\n        *         returns {@code false}\n        */\n    // 返回包含那些可能正在等待此条件的线程集合\n    protected final Collection<Thread> getWaitingThreads() {\n        if (!isHeldExclusively())\n            throw new IllegalMonitorStateException();\n        ArrayList<Thread> list = new ArrayList<Thread>();\n        for (Node w = firstWaiter; w != null; w = w.nextWaiter) {\n            if (w.waitStatus == Node.CONDITION) {\n                Thread t = w.thread;\n                if (t != null)\n                    list.add(t);\n            }\n        }\n        return list;\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br"),s("span",{staticClass:"line-number"},[n._v("59")]),s("br"),s("span",{staticClass:"line-number"},[n._v("60")]),s("br"),s("span",{staticClass:"line-number"},[n._v("61")]),s("br"),s("span",{staticClass:"line-number"},[n._v("62")]),s("br"),s("span",{staticClass:"line-number"},[n._v("63")]),s("br"),s("span",{staticClass:"line-number"},[n._v("64")]),s("br"),s("span",{staticClass:"line-number"},[n._v("65")]),s("br"),s("span",{staticClass:"line-number"},[n._v("66")]),s("br"),s("span",{staticClass:"line-number"},[n._v("67")]),s("br"),s("span",{staticClass:"line-number"},[n._v("68")]),s("br"),s("span",{staticClass:"line-number"},[n._v("69")]),s("br"),s("span",{staticClass:"line-number"},[n._v("70")]),s("br"),s("span",{staticClass:"line-number"},[n._v("71")]),s("br"),s("span",{staticClass:"line-number"},[n._v("72")]),s("br"),s("span",{staticClass:"line-number"},[n._v("73")]),s("br"),s("span",{staticClass:"line-number"},[n._v("74")]),s("br"),s("span",{staticClass:"line-number"},[n._v("75")]),s("br"),s("span",{staticClass:"line-number"},[n._v("76")]),s("br"),s("span",{staticClass:"line-number"},[n._v("77")]),s("br"),s("span",{staticClass:"line-number"},[n._v("78")]),s("br"),s("span",{staticClass:"line-number"},[n._v("79")]),s("br"),s("span",{staticClass:"line-number"},[n._v("80")]),s("br"),s("span",{staticClass:"line-number"},[n._v("81")]),s("br"),s("span",{staticClass:"line-number"},[n._v("82")]),s("br"),s("span",{staticClass:"line-number"},[n._v("83")]),s("br"),s("span",{staticClass:"line-number"},[n._v("84")]),s("br"),s("span",{staticClass:"line-number"},[n._v("85")]),s("br"),s("span",{staticClass:"line-number"},[n._v("86")]),s("br"),s("span",{staticClass:"line-number"},[n._v("87")]),s("br"),s("span",{staticClass:"line-number"},[n._v("88")]),s("br"),s("span",{staticClass:"line-number"},[n._v("89")]),s("br"),s("span",{staticClass:"line-number"},[n._v("90")]),s("br"),s("span",{staticClass:"line-number"},[n._v("91")]),s("br"),s("span",{staticClass:"line-number"},[n._v("92")]),s("br"),s("span",{staticClass:"line-number"},[n._v("93")]),s("br"),s("span",{staticClass:"line-number"},[n._v("94")]),s("br"),s("span",{staticClass:"line-number"},[n._v("95")]),s("br"),s("span",{staticClass:"line-number"},[n._v("96")]),s("br"),s("span",{staticClass:"line-number"},[n._v("97")]),s("br"),s("span",{staticClass:"line-number"},[n._v("98")]),s("br"),s("span",{staticClass:"line-number"},[n._v("99")]),s("br"),s("span",{staticClass:"line-number"},[n._v("100")]),s("br"),s("span",{staticClass:"line-number"},[n._v("101")]),s("br"),s("span",{staticClass:"line-number"},[n._v("102")]),s("br"),s("span",{staticClass:"line-number"},[n._v("103")]),s("br"),s("span",{staticClass:"line-number"},[n._v("104")]),s("br"),s("span",{staticClass:"line-number"},[n._v("105")]),s("br"),s("span",{staticClass:"line-number"},[n._v("106")]),s("br"),s("span",{staticClass:"line-number"},[n._v("107")]),s("br"),s("span",{staticClass:"line-number"},[n._v("108")]),s("br"),s("span",{staticClass:"line-number"},[n._v("109")]),s("br"),s("span",{staticClass:"line-number"},[n._v("110")]),s("br"),s("span",{staticClass:"line-number"},[n._v("111")]),s("br"),s("span",{staticClass:"line-number"},[n._v("112")]),s("br"),s("span",{staticClass:"line-number"},[n._v("113")]),s("br"),s("span",{staticClass:"line-number"},[n._v("114")]),s("br"),s("span",{staticClass:"line-number"},[n._v("115")]),s("br"),s("span",{staticClass:"line-number"},[n._v("116")]),s("br"),s("span",{staticClass:"line-number"},[n._v("117")]),s("br"),s("span",{staticClass:"line-number"},[n._v("118")]),s("br"),s("span",{staticClass:"line-number"},[n._v("119")]),s("br"),s("span",{staticClass:"line-number"},[n._v("120")]),s("br"),s("span",{staticClass:"line-number"},[n._v("121")]),s("br"),s("span",{staticClass:"line-number"},[n._v("122")]),s("br"),s("span",{staticClass:"line-number"},[n._v("123")]),s("br"),s("span",{staticClass:"line-number"},[n._v("124")]),s("br"),s("span",{staticClass:"line-number"},[n._v("125")]),s("br"),s("span",{staticClass:"line-number"},[n._v("126")]),s("br"),s("span",{staticClass:"line-number"},[n._v("127")]),s("br"),s("span",{staticClass:"line-number"},[n._v("128")]),s("br"),s("span",{staticClass:"line-number"},[n._v("129")]),s("br"),s("span",{staticClass:"line-number"},[n._v("130")]),s("br"),s("span",{staticClass:"line-number"},[n._v("131")]),s("br"),s("span",{staticClass:"line-number"},[n._v("132")]),s("br"),s("span",{staticClass:"line-number"},[n._v("133")]),s("br"),s("span",{staticClass:"line-number"},[n._v("134")]),s("br"),s("span",{staticClass:"line-number"},[n._v("135")]),s("br"),s("span",{staticClass:"line-number"},[n._v("136")]),s("br"),s("span",{staticClass:"line-number"},[n._v("137")]),s("br"),s("span",{staticClass:"line-number"},[n._v("138")]),s("br"),s("span",{staticClass:"line-number"},[n._v("139")]),s("br"),s("span",{staticClass:"line-number"},[n._v("140")]),s("br"),s("span",{staticClass:"line-number"},[n._v("141")]),s("br"),s("span",{staticClass:"line-number"},[n._v("142")]),s("br"),s("span",{staticClass:"line-number"},[n._v("143")]),s("br"),s("span",{staticClass:"line-number"},[n._v("144")]),s("br"),s("span",{staticClass:"line-number"},[n._v("145")]),s("br"),s("span",{staticClass:"line-number"},[n._v("146")]),s("br"),s("span",{staticClass:"line-number"},[n._v("147")]),s("br"),s("span",{staticClass:"line-number"},[n._v("148")]),s("br"),s("span",{staticClass:"line-number"},[n._v("149")]),s("br"),s("span",{staticClass:"line-number"},[n._v("150")]),s("br"),s("span",{staticClass:"line-number"},[n._v("151")]),s("br"),s("span",{staticClass:"line-number"},[n._v("152")]),s("br"),s("span",{staticClass:"line-number"},[n._v("153")]),s("br"),s("span",{staticClass:"line-number"},[n._v("154")]),s("br"),s("span",{staticClass:"line-number"},[n._v("155")]),s("br"),s("span",{staticClass:"line-number"},[n._v("156")]),s("br"),s("span",{staticClass:"line-number"},[n._v("157")]),s("br"),s("span",{staticClass:"line-number"},[n._v("158")]),s("br"),s("span",{staticClass:"line-number"},[n._v("159")]),s("br"),s("span",{staticClass:"line-number"},[n._v("160")]),s("br"),s("span",{staticClass:"line-number"},[n._v("161")]),s("br"),s("span",{staticClass:"line-number"},[n._v("162")]),s("br"),s("span",{staticClass:"line-number"},[n._v("163")]),s("br"),s("span",{staticClass:"line-number"},[n._v("164")]),s("br"),s("span",{staticClass:"line-number"},[n._v("165")]),s("br"),s("span",{staticClass:"line-number"},[n._v("166")]),s("br"),s("span",{staticClass:"line-number"},[n._v("167")]),s("br"),s("span",{staticClass:"line-number"},[n._v("168")]),s("br"),s("span",{staticClass:"line-number"},[n._v("169")]),s("br"),s("span",{staticClass:"line-number"},[n._v("170")]),s("br"),s("span",{staticClass:"line-number"},[n._v("171")]),s("br"),s("span",{staticClass:"line-number"},[n._v("172")]),s("br"),s("span",{staticClass:"line-number"},[n._v("173")]),s("br"),s("span",{staticClass:"line-number"},[n._v("174")]),s("br"),s("span",{staticClass:"line-number"},[n._v("175")]),s("br"),s("span",{staticClass:"line-number"},[n._v("176")]),s("br"),s("span",{staticClass:"line-number"},[n._v("177")]),s("br"),s("span",{staticClass:"line-number"},[n._v("178")]),s("br"),s("span",{staticClass:"line-number"},[n._v("179")]),s("br"),s("span",{staticClass:"line-number"},[n._v("180")]),s("br"),s("span",{staticClass:"line-number"},[n._v("181")]),s("br"),s("span",{staticClass:"line-number"},[n._v("182")]),s("br"),s("span",{staticClass:"line-number"},[n._v("183")]),s("br"),s("span",{staticClass:"line-number"},[n._v("184")]),s("br"),s("span",{staticClass:"line-number"},[n._v("185")]),s("br"),s("span",{staticClass:"line-number"},[n._v("186")]),s("br"),s("span",{staticClass:"line-number"},[n._v("187")]),s("br"),s("span",{staticClass:"line-number"},[n._v("188")]),s("br"),s("span",{staticClass:"line-number"},[n._v("189")]),s("br"),s("span",{staticClass:"line-number"},[n._v("190")]),s("br"),s("span",{staticClass:"line-number"},[n._v("191")]),s("br"),s("span",{staticClass:"line-number"},[n._v("192")]),s("br"),s("span",{staticClass:"line-number"},[n._v("193")]),s("br"),s("span",{staticClass:"line-number"},[n._v("194")]),s("br"),s("span",{staticClass:"line-number"},[n._v("195")]),s("br"),s("span",{staticClass:"line-number"},[n._v("196")]),s("br"),s("span",{staticClass:"line-number"},[n._v("197")]),s("br"),s("span",{staticClass:"line-number"},[n._v("198")]),s("br"),s("span",{staticClass:"line-number"},[n._v("199")]),s("br"),s("span",{staticClass:"line-number"},[n._v("200")]),s("br"),s("span",{staticClass:"line-number"},[n._v("201")]),s("br"),s("span",{staticClass:"line-number"},[n._v("202")]),s("br"),s("span",{staticClass:"line-number"},[n._v("203")]),s("br"),s("span",{staticClass:"line-number"},[n._v("204")]),s("br"),s("span",{staticClass:"line-number"},[n._v("205")]),s("br"),s("span",{staticClass:"line-number"},[n._v("206")]),s("br"),s("span",{staticClass:"line-number"},[n._v("207")]),s("br"),s("span",{staticClass:"line-number"},[n._v("208")]),s("br"),s("span",{staticClass:"line-number"},[n._v("209")]),s("br"),s("span",{staticClass:"line-number"},[n._v("210")]),s("br"),s("span",{staticClass:"line-number"},[n._v("211")]),s("br"),s("span",{staticClass:"line-number"},[n._v("212")]),s("br"),s("span",{staticClass:"line-number"},[n._v("213")]),s("br"),s("span",{staticClass:"line-number"},[n._v("214")]),s("br"),s("span",{staticClass:"line-number"},[n._v("215")]),s("br"),s("span",{staticClass:"line-number"},[n._v("216")]),s("br"),s("span",{staticClass:"line-number"},[n._v("217")]),s("br"),s("span",{staticClass:"line-number"},[n._v("218")]),s("br"),s("span",{staticClass:"line-number"},[n._v("219")]),s("br"),s("span",{staticClass:"line-number"},[n._v("220")]),s("br"),s("span",{staticClass:"line-number"},[n._v("221")]),s("br"),s("span",{staticClass:"line-number"},[n._v("222")]),s("br"),s("span",{staticClass:"line-number"},[n._v("223")]),s("br"),s("span",{staticClass:"line-number"},[n._v("224")]),s("br"),s("span",{staticClass:"line-number"},[n._v("225")]),s("br"),s("span",{staticClass:"line-number"},[n._v("226")]),s("br"),s("span",{staticClass:"line-number"},[n._v("227")]),s("br"),s("span",{staticClass:"line-number"},[n._v("228")]),s("br"),s("span",{staticClass:"line-number"},[n._v("229")]),s("br"),s("span",{staticClass:"line-number"},[n._v("230")]),s("br"),s("span",{staticClass:"line-number"},[n._v("231")]),s("br"),s("span",{staticClass:"line-number"},[n._v("232")]),s("br"),s("span",{staticClass:"line-number"},[n._v("233")]),s("br"),s("span",{staticClass:"line-number"},[n._v("234")]),s("br"),s("span",{staticClass:"line-number"},[n._v("235")]),s("br"),s("span",{staticClass:"line-number"},[n._v("236")]),s("br"),s("span",{staticClass:"line-number"},[n._v("237")]),s("br"),s("span",{staticClass:"line-number"},[n._v("238")]),s("br"),s("span",{staticClass:"line-number"},[n._v("239")]),s("br"),s("span",{staticClass:"line-number"},[n._v("240")]),s("br"),s("span",{staticClass:"line-number"},[n._v("241")]),s("br"),s("span",{staticClass:"line-number"},[n._v("242")]),s("br"),s("span",{staticClass:"line-number"},[n._v("243")]),s("br"),s("span",{staticClass:"line-number"},[n._v("244")]),s("br"),s("span",{staticClass:"line-number"},[n._v("245")]),s("br"),s("span",{staticClass:"line-number"},[n._v("246")]),s("br"),s("span",{staticClass:"line-number"},[n._v("247")]),s("br"),s("span",{staticClass:"line-number"},[n._v("248")]),s("br"),s("span",{staticClass:"line-number"},[n._v("249")]),s("br"),s("span",{staticClass:"line-number"},[n._v("250")]),s("br"),s("span",{staticClass:"line-number"},[n._v("251")]),s("br"),s("span",{staticClass:"line-number"},[n._v("252")]),s("br"),s("span",{staticClass:"line-number"},[n._v("253")]),s("br"),s("span",{staticClass:"line-number"},[n._v("254")]),s("br"),s("span",{staticClass:"line-number"},[n._v("255")]),s("br"),s("span",{staticClass:"line-number"},[n._v("256")]),s("br"),s("span",{staticClass:"line-number"},[n._v("257")]),s("br"),s("span",{staticClass:"line-number"},[n._v("258")]),s("br"),s("span",{staticClass:"line-number"},[n._v("259")]),s("br"),s("span",{staticClass:"line-number"},[n._v("260")]),s("br"),s("span",{staticClass:"line-number"},[n._v("261")]),s("br"),s("span",{staticClass:"line-number"},[n._v("262")]),s("br"),s("span",{staticClass:"line-number"},[n._v("263")]),s("br"),s("span",{staticClass:"line-number"},[n._v("264")]),s("br"),s("span",{staticClass:"line-number"},[n._v("265")]),s("br"),s("span",{staticClass:"line-number"},[n._v("266")]),s("br"),s("span",{staticClass:"line-number"},[n._v("267")]),s("br"),s("span",{staticClass:"line-number"},[n._v("268")]),s("br"),s("span",{staticClass:"line-number"},[n._v("269")]),s("br"),s("span",{staticClass:"line-number"},[n._v("270")]),s("br"),s("span",{staticClass:"line-number"},[n._v("271")]),s("br"),s("span",{staticClass:"line-number"},[n._v("272")]),s("br"),s("span",{staticClass:"line-number"},[n._v("273")]),s("br"),s("span",{staticClass:"line-number"},[n._v("274")]),s("br"),s("span",{staticClass:"line-number"},[n._v("275")]),s("br"),s("span",{staticClass:"line-number"},[n._v("276")]),s("br"),s("span",{staticClass:"line-number"},[n._v("277")]),s("br"),s("span",{staticClass:"line-number"},[n._v("278")]),s("br"),s("span",{staticClass:"line-number"},[n._v("279")]),s("br"),s("span",{staticClass:"line-number"},[n._v("280")]),s("br"),s("span",{staticClass:"line-number"},[n._v("281")]),s("br"),s("span",{staticClass:"line-number"},[n._v("282")]),s("br"),s("span",{staticClass:"line-number"},[n._v("283")]),s("br"),s("span",{staticClass:"line-number"},[n._v("284")]),s("br"),s("span",{staticClass:"line-number"},[n._v("285")]),s("br"),s("span",{staticClass:"line-number"},[n._v("286")]),s("br"),s("span",{staticClass:"line-number"},[n._v("287")]),s("br"),s("span",{staticClass:"line-number"},[n._v("288")]),s("br"),s("span",{staticClass:"line-number"},[n._v("289")]),s("br"),s("span",{staticClass:"line-number"},[n._v("290")]),s("br"),s("span",{staticClass:"line-number"},[n._v("291")]),s("br"),s("span",{staticClass:"line-number"},[n._v("292")]),s("br"),s("span",{staticClass:"line-number"},[n._v("293")]),s("br"),s("span",{staticClass:"line-number"},[n._v("294")]),s("br"),s("span",{staticClass:"line-number"},[n._v("295")]),s("br"),s("span",{staticClass:"line-number"},[n._v("296")]),s("br"),s("span",{staticClass:"line-number"},[n._v("297")]),s("br"),s("span",{staticClass:"line-number"},[n._v("298")]),s("br"),s("span",{staticClass:"line-number"},[n._v("299")]),s("br"),s("span",{staticClass:"line-number"},[n._v("300")]),s("br"),s("span",{staticClass:"line-number"},[n._v("301")]),s("br"),s("span",{staticClass:"line-number"},[n._v("302")]),s("br"),s("span",{staticClass:"line-number"},[n._v("303")]),s("br"),s("span",{staticClass:"line-number"},[n._v("304")]),s("br"),s("span",{staticClass:"line-number"},[n._v("305")]),s("br"),s("span",{staticClass:"line-number"},[n._v("306")]),s("br"),s("span",{staticClass:"line-number"},[n._v("307")]),s("br"),s("span",{staticClass:"line-number"},[n._v("308")]),s("br"),s("span",{staticClass:"line-number"},[n._v("309")]),s("br"),s("span",{staticClass:"line-number"},[n._v("310")]),s("br"),s("span",{staticClass:"line-number"},[n._v("311")]),s("br"),s("span",{staticClass:"line-number"},[n._v("312")]),s("br"),s("span",{staticClass:"line-number"},[n._v("313")]),s("br"),s("span",{staticClass:"line-number"},[n._v("314")]),s("br"),s("span",{staticClass:"line-number"},[n._v("315")]),s("br"),s("span",{staticClass:"line-number"},[n._v("316")]),s("br"),s("span",{staticClass:"line-number"},[n._v("317")]),s("br"),s("span",{staticClass:"line-number"},[n._v("318")]),s("br"),s("span",{staticClass:"line-number"},[n._v("319")]),s("br"),s("span",{staticClass:"line-number"},[n._v("320")]),s("br"),s("span",{staticClass:"line-number"},[n._v("321")]),s("br"),s("span",{staticClass:"line-number"},[n._v("322")]),s("br"),s("span",{staticClass:"line-number"},[n._v("323")]),s("br"),s("span",{staticClass:"line-number"},[n._v("324")]),s("br"),s("span",{staticClass:"line-number"},[n._v("325")]),s("br"),s("span",{staticClass:"line-number"},[n._v("326")]),s("br"),s("span",{staticClass:"line-number"},[n._v("327")]),s("br"),s("span",{staticClass:"line-number"},[n._v("328")]),s("br"),s("span",{staticClass:"line-number"},[n._v("329")]),s("br"),s("span",{staticClass:"line-number"},[n._v("330")]),s("br"),s("span",{staticClass:"line-number"},[n._v("331")]),s("br"),s("span",{staticClass:"line-number"},[n._v("332")]),s("br"),s("span",{staticClass:"line-number"},[n._v("333")]),s("br"),s("span",{staticClass:"line-number"},[n._v("334")]),s("br"),s("span",{staticClass:"line-number"},[n._v("335")]),s("br"),s("span",{staticClass:"line-number"},[n._v("336")]),s("br"),s("span",{staticClass:"line-number"},[n._v("337")]),s("br"),s("span",{staticClass:"line-number"},[n._v("338")]),s("br"),s("span",{staticClass:"line-number"},[n._v("339")]),s("br"),s("span",{staticClass:"line-number"},[n._v("340")]),s("br"),s("span",{staticClass:"line-number"},[n._v("341")]),s("br"),s("span",{staticClass:"line-number"},[n._v("342")]),s("br"),s("span",{staticClass:"line-number"},[n._v("343")]),s("br"),s("span",{staticClass:"line-number"},[n._v("344")]),s("br"),s("span",{staticClass:"line-number"},[n._v("345")]),s("br"),s("span",{staticClass:"line-number"},[n._v("346")]),s("br"),s("span",{staticClass:"line-number"},[n._v("347")]),s("br"),s("span",{staticClass:"line-number"},[n._v("348")]),s("br"),s("span",{staticClass:"line-number"},[n._v("349")]),s("br"),s("span",{staticClass:"line-number"},[n._v("350")]),s("br"),s("span",{staticClass:"line-number"},[n._v("351")]),s("br"),s("span",{staticClass:"line-number"},[n._v("352")]),s("br"),s("span",{staticClass:"line-number"},[n._v("353")]),s("br"),s("span",{staticClass:"line-number"},[n._v("354")]),s("br"),s("span",{staticClass:"line-number"},[n._v("355")]),s("br"),s("span",{staticClass:"line-number"},[n._v("356")]),s("br"),s("span",{staticClass:"line-number"},[n._v("357")]),s("br"),s("span",{staticClass:"line-number"},[n._v("358")]),s("br"),s("span",{staticClass:"line-number"},[n._v("359")]),s("br"),s("span",{staticClass:"line-number"},[n._v("360")]),s("br"),s("span",{staticClass:"line-number"},[n._v("361")]),s("br"),s("span",{staticClass:"line-number"},[n._v("362")]),s("br"),s("span",{staticClass:"line-number"},[n._v("363")]),s("br"),s("span",{staticClass:"line-number"},[n._v("364")]),s("br"),s("span",{staticClass:"line-number"},[n._v("365")]),s("br"),s("span",{staticClass:"line-number"},[n._v("366")]),s("br"),s("span",{staticClass:"line-number"},[n._v("367")]),s("br"),s("span",{staticClass:"line-number"},[n._v("368")]),s("br"),s("span",{staticClass:"line-number"},[n._v("369")]),s("br"),s("span",{staticClass:"line-number"},[n._v("370")]),s("br"),s("span",{staticClass:"line-number"},[n._v("371")]),s("br"),s("span",{staticClass:"line-number"},[n._v("372")]),s("br"),s("span",{staticClass:"line-number"},[n._v("373")]),s("br"),s("span",{staticClass:"line-number"},[n._v("374")]),s("br"),s("span",{staticClass:"line-number"},[n._v("375")]),s("br"),s("span",{staticClass:"line-number"},[n._v("376")]),s("br"),s("span",{staticClass:"line-number"},[n._v("377")]),s("br"),s("span",{staticClass:"line-number"},[n._v("378")]),s("br"),s("span",{staticClass:"line-number"},[n._v("379")]),s("br"),s("span",{staticClass:"line-number"},[n._v("380")]),s("br"),s("span",{staticClass:"line-number"},[n._v("381")]),s("br"),s("span",{staticClass:"line-number"},[n._v("382")]),s("br"),s("span",{staticClass:"line-number"},[n._v("383")]),s("br"),s("span",{staticClass:"line-number"},[n._v("384")]),s("br"),s("span",{staticClass:"line-number"},[n._v("385")]),s("br"),s("span",{staticClass:"line-number"},[n._v("386")]),s("br"),s("span",{staticClass:"line-number"},[n._v("387")]),s("br"),s("span",{staticClass:"line-number"},[n._v("388")]),s("br"),s("span",{staticClass:"line-number"},[n._v("389")]),s("br"),s("span",{staticClass:"line-number"},[n._v("390")]),s("br"),s("span",{staticClass:"line-number"},[n._v("391")]),s("br"),s("span",{staticClass:"line-number"},[n._v("392")]),s("br"),s("span",{staticClass:"line-number"},[n._v("393")]),s("br"),s("span",{staticClass:"line-number"},[n._v("394")]),s("br"),s("span",{staticClass:"line-number"},[n._v("395")]),s("br"),s("span",{staticClass:"line-number"},[n._v("396")]),s("br"),s("span",{staticClass:"line-number"},[n._v("397")]),s("br"),s("span",{staticClass:"line-number"},[n._v("398")]),s("br"),s("span",{staticClass:"line-number"},[n._v("399")]),s("br"),s("span",{staticClass:"line-number"},[n._v("400")]),s("br"),s("span",{staticClass:"line-number"},[n._v("401")]),s("br"),s("span",{staticClass:"line-number"},[n._v("402")]),s("br"),s("span",{staticClass:"line-number"},[n._v("403")]),s("br"),s("span",{staticClass:"line-number"},[n._v("404")]),s("br"),s("span",{staticClass:"line-number"},[n._v("405")]),s("br"),s("span",{staticClass:"line-number"},[n._v("406")]),s("br"),s("span",{staticClass:"line-number"},[n._v("407")]),s("br"),s("span",{staticClass:"line-number"},[n._v("408")]),s("br"),s("span",{staticClass:"line-number"},[n._v("409")]),s("br"),s("span",{staticClass:"line-number"},[n._v("410")]),s("br"),s("span",{staticClass:"line-number"},[n._v("411")]),s("br"),s("span",{staticClass:"line-number"},[n._v("412")]),s("br"),s("span",{staticClass:"line-number"},[n._v("413")]),s("br"),s("span",{staticClass:"line-number"},[n._v("414")]),s("br"),s("span",{staticClass:"line-number"},[n._v("415")]),s("br"),s("span",{staticClass:"line-number"},[n._v("416")]),s("br"),s("span",{staticClass:"line-number"},[n._v("417")]),s("br"),s("span",{staticClass:"line-number"},[n._v("418")]),s("br"),s("span",{staticClass:"line-number"},[n._v("419")]),s("br"),s("span",{staticClass:"line-number"},[n._v("420")]),s("br"),s("span",{staticClass:"line-number"},[n._v("421")]),s("br"),s("span",{staticClass:"line-number"},[n._v("422")]),s("br"),s("span",{staticClass:"line-number"},[n._v("423")]),s("br"),s("span",{staticClass:"line-number"},[n._v("424")]),s("br"),s("span",{staticClass:"line-number"},[n._v("425")]),s("br"),s("span",{staticClass:"line-number"},[n._v("426")]),s("br"),s("span",{staticClass:"line-number"},[n._v("427")]),s("br"),s("span",{staticClass:"line-number"},[n._v("428")]),s("br"),s("span",{staticClass:"line-number"},[n._v("429")]),s("br"),s("span",{staticClass:"line-number"},[n._v("430")]),s("br"),s("span",{staticClass:"line-number"},[n._v("431")]),s("br"),s("span",{staticClass:"line-number"},[n._v("432")]),s("br"),s("span",{staticClass:"line-number"},[n._v("433")]),s("br"),s("span",{staticClass:"line-number"},[n._v("434")]),s("br"),s("span",{staticClass:"line-number"},[n._v("435")]),s("br"),s("span",{staticClass:"line-number"},[n._v("436")]),s("br"),s("span",{staticClass:"line-number"},[n._v("437")]),s("br"),s("span",{staticClass:"line-number"},[n._v("438")]),s("br"),s("span",{staticClass:"line-number"},[n._v("439")]),s("br"),s("span",{staticClass:"line-number"},[n._v("440")]),s("br"),s("span",{staticClass:"line-number"},[n._v("441")]),s("br"),s("span",{staticClass:"line-number"},[n._v("442")]),s("br"),s("span",{staticClass:"line-number"},[n._v("443")]),s("br"),s("span",{staticClass:"line-number"},[n._v("444")]),s("br"),s("span",{staticClass:"line-number"},[n._v("445")]),s("br"),s("span",{staticClass:"line-number"},[n._v("446")]),s("br"),s("span",{staticClass:"line-number"},[n._v("447")]),s("br"),s("span",{staticClass:"line-number"},[n._v("448")]),s("br"),s("span",{staticClass:"line-number"},[n._v("449")]),s("br"),s("span",{staticClass:"line-number"},[n._v("450")]),s("br"),s("span",{staticClass:"line-number"},[n._v("451")]),s("br"),s("span",{staticClass:"line-number"},[n._v("452")]),s("br"),s("span",{staticClass:"line-number"},[n._v("453")]),s("br"),s("span",{staticClass:"line-number"},[n._v("454")]),s("br"),s("span",{staticClass:"line-number"},[n._v("455")]),s("br"),s("span",{staticClass:"line-number"},[n._v("456")]),s("br"),s("span",{staticClass:"line-number"},[n._v("457")]),s("br"),s("span",{staticClass:"line-number"},[n._v("458")]),s("br"),s("span",{staticClass:"line-number"},[n._v("459")]),s("br"),s("span",{staticClass:"line-number"},[n._v("460")]),s("br"),s("span",{staticClass:"line-number"},[n._v("461")]),s("br"),s("span",{staticClass:"line-number"},[n._v("462")]),s("br"),s("span",{staticClass:"line-number"},[n._v("463")]),s("br"),s("span",{staticClass:"line-number"},[n._v("464")]),s("br"),s("span",{staticClass:"line-number"},[n._v("465")]),s("br"),s("span",{staticClass:"line-number"},[n._v("466")]),s("br"),s("span",{staticClass:"line-number"},[n._v("467")]),s("br"),s("span",{staticClass:"line-number"},[n._v("468")]),s("br"),s("span",{staticClass:"line-number"},[n._v("469")]),s("br"),s("span",{staticClass:"line-number"},[n._v("470")]),s("br"),s("span",{staticClass:"line-number"},[n._v("471")]),s("br"),s("span",{staticClass:"line-number"},[n._v("472")]),s("br")])]),s("blockquote",[s("p",[n._v("此类实现了Condition接口，Condition接口定义了条件操作规范，具体如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("public interface Condition {\n\n    // 等待，当前线程在接到信号或被中断之前一直处于等待状态\n    void await() throws InterruptedException;\n\n    // 等待，当前线程在接到信号之前一直处于等待状态，不响应中断\n    void awaitUninterruptibly();\n\n    //等待，当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态 \n    long awaitNanos(long nanosTimeout) throws InterruptedException;\n\n    // 等待，当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态。此方法在行为上等效于: awaitNanos(unit.toNanos(time)) > 0\n    boolean await(long time, TimeUnit unit) throws InterruptedException;\n\n    // 等待，当前线程在接到信号、被中断或到达指定最后期限之前一直处于等待状态\n    boolean awaitUntil(Date deadline) throws InterruptedException;\n\n    // 唤醒一个等待线程。如果所有的线程都在等待此条件，则选择其中的一个唤醒。在从 await 返回之前，该线程必须重新获取锁。\n    void signal();\n\n    // 唤醒所有等待线程。如果所有的线程都在等待此条件，则唤醒所有线程。在从 await 返回之前，每个线程都必须重新获取锁。\n    void signalAll();\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br")])]),s("blockquote",[s("p",[n._v("Condition接口中定义了await、signal方法，用来等待条件、释放条件。之后会详细分析CondtionObject的源码。")])]),n._v(" "),s("h3",{attrs:{id:"类的属性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#类的属性"}},[n._v("#")]),n._v(" # 类的属性")]),n._v(" "),s("blockquote",[s("p",[n._v("属性中包含了头节点head，尾结点tail，状态state、自旋时间spinForTimeoutThreshold，还有AbstractQueuedSynchronizer抽象的属性在内存中的偏移地址，通过该偏移地址，可以获取和设置该属性的值，同时还包括一个静态初始化块，用于加载内存偏移地址。")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer\n    implements java.io.Serializable {    \n    // 版本号\n    private static final long serialVersionUID = 7373984972572414691L;    \n    // 头节点\n    private transient volatile Node head;    \n    // 尾结点\n    private transient volatile Node tail;    \n    // 状态\n    private volatile int state;    \n    // 自旋时间\n    static final long spinForTimeoutThreshold = 1000L;\n\n    // Unsafe类实例\n    private static final Unsafe unsafe = Unsafe.getUnsafe();\n    // state内存偏移地址\n    private static final long stateOffset;\n    // head内存偏移地址\n    private static final long headOffset;\n    // state内存偏移地址\n    private static final long tailOffset;\n    // tail内存偏移地址\n    private static final long waitStatusOffset;\n    // next内存偏移地址\n    private static final long nextOffset;\n    // 静态初始化块\n    static {\n        try {\n            stateOffset = unsafe.objectFieldOffset\n                (AbstractQueuedSynchronizer.class.getDeclaredField("state"));\n            headOffset = unsafe.objectFieldOffset\n                (AbstractQueuedSynchronizer.class.getDeclaredField("head"));\n            tailOffset = unsafe.objectFieldOffset\n                (AbstractQueuedSynchronizer.class.getDeclaredField("tail"));\n            waitStatusOffset = unsafe.objectFieldOffset\n                (Node.class.getDeclaredField("waitStatus"));\n            nextOffset = unsafe.objectFieldOffset\n                (Node.class.getDeclaredField("next"));\n\n        } catch (Exception ex) { throw new Error(ex); }\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br")])]),s("h3",{attrs:{id:"类的构造方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#类的构造方法"}},[n._v("#")]),n._v(" # 类的构造方法")]),n._v(" "),s("blockquote",[s("p",[n._v("此类构造方法为从抽象构造方法，供子类调用。")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("protected AbstractQueuedSynchronizer() { }\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("h3",{attrs:{id:"类的核心方法-acquire方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#类的核心方法-acquire方法"}},[n._v("#")]),n._v(" # 类的核心方法 - acquire方法")]),n._v(" "),s("blockquote",[s("p",[n._v("该方法以独占模式获取(资源)，忽略中断，即线程在aquire过程中，中断此线程是无效的。源码如下:")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("public final void acquire(int arg) {\n    if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\n        selfInterrupt();\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("blockquote",[s("p",[n._v("由上述源码可以知道，当一个线程调用acquire时，调用方法流程如下")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-2.png)")])]),n._v(" "),s("ul",[s("li",[s("blockquote",[s("p",[n._v("首先调用tryAcquire方法，调用此方法的线程会试图在独占模式下获取对象状态。此方法应该查询是否允许它在独占模式下获取对象状态，如果允许，则获取它。在AbstractQueuedSynchronizer源码中默认会抛出一个异常，即需要子类去重写此方法完成自己的逻辑。之后会进行分析。")])])]),n._v(" "),s("li",[s("blockquote",[s("p",[n._v("若tryAcquire失败，则调用addWaiter方法，addWaiter方法完成的功能是将调用此方法的线程封装成为一个结点并放入Sync queue。")])])]),n._v(" "),s("li",[s("blockquote",[s("p",[n._v("调用acquireQueued方法，此方法完成的功能是Sync queue中的结点不断尝试获取资源，若成功，则返回true，否则，返回false。")])])]),n._v(" "),s("li",[s("blockquote",[s("p",[n._v("由于tryAcquire默认实现是抛出异常，所以此时，不进行分析，之后会结合一个例子进行分析。")])])])]),n._v(" "),s("blockquote",[s("p",[n._v("首先分析addWaiter方法")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("// 添加等待者\nprivate Node addWaiter(Node mode) {\n    // 新生成一个结点，默认为独占模式\n    Node node = new Node(Thread.currentThread(), mode);\n    // Try the fast path of enq; backup to full enq on failure\n    // 保存尾结点\n    Node pred = tail;\n    if (pred != null) { // 尾结点不为空，即已经被初始化\n        // 将node结点的prev域连接到尾结点\n        node.prev = pred; \n        if (compareAndSetTail(pred, node)) { // 比较pred是否为尾结点，是则将尾结点设置为node \n            // 设置尾结点的next域为node\n            pred.next = node;\n            return node; // 返回新生成的结点\n        }\n    }\n    enq(node); // 尾结点为空(即还没有被初始化过)，或者是compareAndSetTail操作失败，则入队列\n    return node;\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br")])]),s("blockquote",[s("p",[n._v("addWaiter方法使用快速添加的方式往sync queue尾部添加结点，如果sync queue队列还没有初始化，则会使用enq插入队列中，enq方法源码如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("private Node enq(final Node node) {\n    for (;;) { // 无限循环，确保结点能够成功入队列\n        // 保存尾结点\n        Node t = tail;\n        if (t == null) { // 尾结点为空，即还没被初始化\n            if (compareAndSetHead(new Node())) // 头节点为空，并设置头节点为新生成的结点\n                tail = head; // 头节点与尾结点都指向同一个新生结点\n        } else { // 尾结点不为空，即已经被初始化过\n            // 将node结点的prev域连接到尾结点\n            node.prev = t; \n            if (compareAndSetTail(t, node)) { // 比较结点t是否为尾结点，若是则将尾结点设置为node\n                // 设置尾结点的next域为node\n                t.next = node; \n                return t; // 返回尾结点\n            }\n        }\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br")])]),s("blockquote",[s("p",[n._v("enq方法会使用无限循环来确保节点的成功插入。")])]),n._v(" "),s("blockquote",[s("p",[n._v("现在，分析acquireQueue方法。其源码如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("// sync队列中的结点在独占且忽略中断的模式下获取(资源)\nfinal boolean acquireQueued(final Node node, int arg) {\n    // 标志\n    boolean failed = true;\n    try {\n        // 中断标志\n        boolean interrupted = false;\n        for (;;) { // 无限循环\n            // 获取node节点的前驱结点\n            final Node p = node.predecessor(); \n            if (p == head && tryAcquire(arg)) { // 前驱为头节点并且成功获得锁\n                setHead(node); // 设置头节点\n                p.next = null; // help GC\n                failed = false; // 设置标志\n                return interrupted; \n            }\n            if (shouldParkAfterFailedAcquire(p, node) &&\n                parkAndCheckInterrupt())\n                interrupted = true;\n        }\n    } finally {\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br")])]),s("blockquote",[s("p",[n._v("首先获取当前节点的前驱节点，如果前驱节点是头节点并且能够获取(资源)，代表该当前节点能够占有锁，设置头节点为当前节点，返回。否则，调用shouldParkAfterFailedAcquire和parkAndCheckInterrupt方法，首先，我们看shouldParkAfterFailedAcquire方法，代码如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("// 当获取(资源)失败后，检查并且更新结点状态\nprivate static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {\n    // 获取前驱结点的状态\n    int ws = pred.waitStatus;\n    if (ws == Node.SIGNAL) // 状态为SIGNAL，为-1\n        /*\n            * This node has already set status asking a release\n            * to signal it, so it can safely park.\n            */\n        // 可以进行park操作\n        return true; \n    if (ws > 0) { // 表示状态为CANCELLED，为1\n        /*\n            * Predecessor was cancelled. Skip over predecessors and\n            * indicate retry.\n            */\n        do {\n            node.prev = pred = pred.prev;\n        } while (pred.waitStatus > 0); // 找到pred结点前面最近的一个状态不为CANCELLED的结点\n        // 赋值pred结点的next域\n        pred.next = node; \n    } else { // 为PROPAGATE -3 或者是0 表示无状态,(为CONDITION -2时，表示此节点在condition queue中) \n        /*\n            * waitStatus must be 0 or PROPAGATE.  Indicate that we\n            * need a signal, but don't park yet.  Caller will need to\n            * retry to make sure it cannot acquire before parking.\n            */\n        // 比较并设置前驱结点的状态为SIGNAL\n        compareAndSetWaitStatus(pred, ws, Node.SIGNAL); \n    }\n    // 不能进行park操作\n    return false;\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br")])]),s("blockquote",[s("p",[n._v("只有当该节点的前驱结点的状态为SIGNAL时，才可以对该结点所封装的线程进行park操作。否则，将不能进行park操作。再看parkAndCheckInterrupt方法，源码如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("// 进行park操作并且返回该线程是否被中断\nprivate final boolean parkAndCheckInterrupt() {\n    // 在许可可用之前禁用当前线程，并且设置了blocker\n    LockSupport.park(this);\n    return Thread.interrupted(); // 当前线程是否已被中断，并清除中断标记位\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br")])]),s("blockquote",[s("p",[n._v("parkAndCheckInterrupt方法里的逻辑是首先执行park操作，即禁用当前线程，然后返回该线程是否已经被中断。再看final块中的cancelAcquire方法，其源码如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("// 取消继续获取(资源)\nprivate void cancelAcquire(Node node) {\n    // Ignore if node doesn't exist\n    // node为空，返回\n    if (node == null)\n        return;\n    // 设置node结点的thread为空\n    node.thread = null;\n\n    // Skip cancelled predecessors\n    // 保存node的前驱结点\n    Node pred = node.prev;\n    while (pred.waitStatus > 0) // 找到node前驱结点中第一个状态小于0的结点，即不为CANCELLED状态的结点\n        node.prev = pred = pred.prev;\n\n    // predNext is the apparent node to unsplice. CASes below will\n    // fail if not, in which case, we lost race vs another cancel\n    // or signal, so no further action is necessary.\n    // 获取pred结点的下一个结点\n    Node predNext = pred.next;\n\n    // Can use unconditional write instead of CAS here.\n    // After this atomic step, other Nodes can skip past us.\n    // Before, we are free of interference from other threads.\n    // 设置node结点的状态为CANCELLED\n    node.waitStatus = Node.CANCELLED;\n\n    // If we are the tail, remove ourselves.\n    if (node == tail && compareAndSetTail(node, pred)) { // node结点为尾结点，则设置尾结点为pred结点\n        // 比较并设置pred结点的next节点为null\n        compareAndSetNext(pred, predNext, null); \n    } else { // node结点不为尾结点，或者比较设置不成功\n        // If successor needs signal, try to set pred's next-link\n        // so it will get one. Otherwise wake it up to propagate.\n        int ws;\n        if (pred != head &&\n            ((ws = pred.waitStatus) == Node.SIGNAL ||\n                (ws <= 0 && compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &&\n            pred.thread != null) { // (pred结点不为头节点，并且pred结点的状态为SIGNAL)或者 \n                                // pred结点状态小于等于0，并且比较并设置等待状态为SIGNAL成功，并且pred结点所封装的线程不为空\n            // 保存结点的后继\n            Node next = node.next;\n            if (next != null && next.waitStatus <= 0) // 后继不为空并且后继的状态小于等于0\n                compareAndSetNext(pred, predNext, next); // 比较并设置pred.next = next;\n        } else {\n            unparkSuccessor(node); // 释放node的前一个结点\n        }\n\n        node.next = node; // help GC\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br")])]),s("blockquote",[s("p",[n._v("该方法完成的功能就是取消当前线程对资源的获取，即设置该结点的状态为CANCELLED，接着我们再看unparkSuccessor方法，源码如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("// 释放后继结点\nprivate void unparkSuccessor(Node node) {\n    /*\n        * If status is negative (i.e., possibly needing signal) try\n        * to clear in anticipation of signalling.  It is OK if this\n        * fails or if status is changed by waiting thread.\n        */\n    // 获取node结点的等待状态\n    int ws = node.waitStatus;\n    if (ws < 0) // 状态值小于0，为SIGNAL -1 或 CONDITION -2 或 PROPAGATE -3\n        // 比较并且设置结点等待状态，设置为0\n        compareAndSetWaitStatus(node, ws, 0);\n\n    /*\n        * Thread to unpark is held in successor, which is normally\n        * just the next node.  But if cancelled or apparently null,\n        * traverse backwards from tail to find the actual\n        * non-cancelled successor.\n        */\n    // 获取node节点的下一个结点\n    Node s = node.next;\n    if (s == null || s.waitStatus > 0) { // 下一个结点为空或者下一个节点的等待状态大于0，即为CANCELLED\n        // s赋值为空\n        s = null; \n        // 从尾结点开始从后往前开始遍历\n        for (Node t = tail; t != null && t != node; t = t.prev)\n            if (t.waitStatus <= 0) // 找到等待状态小于等于0的结点，找到最前的状态小于等于0的结点\n                // 保存结点\n                s = t;\n    }\n    if (s != null) // 该结点不为为空，释放许可\n        LockSupport.unpark(s.thread);\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br")])]),s("blockquote",[s("p",[n._v("该方法的作用就是为了释放node节点的后继结点。")])]),n._v(" "),s("blockquote",[s("p",[n._v("对于cancelAcquire与unparkSuccessor方法，如下示意图可以清晰的表示:")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-3.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("其中node为参数，在执行完cancelAcquire方法后的效果就是unpark了s结点所包含的t4线程。")])]),n._v(" "),s("blockquote",[s("p",[n._v("现在，再来看acquireQueued方法的整个的逻辑。逻辑如下:")])]),n._v(" "),s("ul",[s("li",[n._v("判断结点的前驱是否为head并且是否成功获取(资源)。")]),n._v(" "),s("li",[n._v("若步骤1均满足，则设置结点为head，之后会判断是否finally模块，然后返回。")]),n._v(" "),s("li",[n._v("若步骤2不满足，则判断是否需要park当前线程，是否需要park当前线程的逻辑是判断结点的前驱结点的状态是否为SIGNAL，若是，则park当前结点，否则，不进行park操作。")]),n._v(" "),s("li",[n._v("若park了当前线程，之后某个线程对本线程unpark后，并且本线程也获得机会运行。那么，将会继续进行步骤①的判断。")])]),n._v(" "),s("h3",{attrs:{id:"类的核心方法-release方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#类的核心方法-release方法"}},[n._v("#")]),n._v(" # 类的核心方法 - release方法")]),n._v(" "),s("blockquote",[s("p",[n._v("以独占模式释放对象，其源码如下:")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("public final boolean release(int arg) {\n    if (tryRelease(arg)) { // 释放成功\n        // 保存头节点\n        Node h = head; \n        if (h != null && h.waitStatus != 0) // 头节点不为空并且头节点状态不为0\n            unparkSuccessor(h); //释放头节点的后继结点\n        return true;\n    }\n    return false;\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br")])]),s("blockquote",[s("p",[n._v("其中，tryRelease的默认实现是抛出异常，需要具体的子类实现，如果tryRelease成功，那么如果头节点不为空并且头节点的状态不为0，则释放头节点的后继结点，unparkSuccessor方法已经分析过，不再累赘。")])]),n._v(" "),s("blockquote",[s("p",[n._v("对于其他方法我们也可以分析，与前面分析的方法大同小异，所以，不再累赘。")])]),n._v(" "),s("h3",{attrs:{id:"abstractqueuedsynchronizer示例详解一"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#abstractqueuedsynchronizer示例详解一"}},[n._v("#")]),n._v(" # AbstractQueuedSynchronizer示例详解一")]),n._v(" "),s("blockquote",[s("p",[n._v("借助下面示例来分析AbstractQueuedSyncrhonizer内部的工作机制。示例源码如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('import java.util.concurrent.locks.Lock;\nimport java.util.concurrent.locks.ReentrantLock;\n\nclass MyThread extends Thread {\n    private Lock lock;\n    public MyThread(String name, Lock lock) {\n        super(name);\n        this.lock = lock;\n    }\n\n    public void run () {\n        lock.lock();\n        try {\n            System.out.println(Thread.currentThread() + " running");\n        } finally {\n            lock.unlock();\n        }\n    }\n}\npublic class AbstractQueuedSynchronizerDemo {\n    public static void main(String[] args) {\n        Lock lock = new ReentrantLock();\n\n        MyThread t1 = new MyThread("t1", lock);\n        MyThread t2 = new MyThread("t2", lock);\n        tstart();\n        tstart();    \n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br")])]),s("blockquote",[s("p",[n._v("运行结果(可能的一种):")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("Thread[t1,5,main] running\nThread[t2,5,main] running\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("blockquote",[s("p",[n._v("结果分析: 从示例可知，线程t1与t2共用了一把锁，即同一个lock。可能会存在如下一种时序。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-4.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 首先线程t1先执行lock.lock操作，然后t2执行lock.lock操作，然后t1执行lock.unlock操作，最后t2执行lock.unlock操作。基于这样的时序，分析AbstractQueuedSynchronizer内部的工作机制。")])]),n._v(" "),s("ul",[s("li",[n._v("t1线程调用lock.lock方法，其方法调用顺序如下，只给出了主要的方法调用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-5.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 其中，前面的部分表示哪个类，后面是具体的类中的哪个方法，AQS表示AbstractQueuedSynchronizer类，AOS表示AbstractOwnableSynchronizer类。")])]),n._v(" "),s("ul",[s("li",[n._v("t2线程调用lock.lock方法，其方法调用顺序如下，只给出了主要的方法调用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-6.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 经过一系列的方法调用，最后达到的状态是禁用t2线程，因为调用了LockSupport.park。")])]),n._v(" "),s("ul",[s("li",[n._v("t1线程调用lock.unlock，其方法调用顺序如下，只给出了主要的方法调用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-7.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: t1线程中调用lock.unlock后，经过一系列的调用，最终的状态是释放了许可，因为调用了LockSupport.unpark。这时，t2线程就可以继续运行了。此时，会继续恢复t2线程运行环境，继续执行LockSupport.park后面的语句，即进一步调用如下。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-8.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 在上一步调用了LockSupport.unpark后，t2线程恢复运行，则运行parkAndCheckInterrupt，之后，继续运行acquireQueued方法，最后达到的状态是头节点head与尾结点tail均指向了t2线程所在的结点，并且之前的头节点已经从sync队列中断开了。")])]),n._v(" "),s("ul",[s("li",[n._v("t2线程调用lock.unlock，其方法调用顺序如下，只给出了主要的方法调用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-9.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: t2线程执行lock.unlock后，最终达到的状态还是与之前的状态一样。")])]),n._v(" "),s("h3",{attrs:{id:"abstractqueuedsynchronizer示例详解二"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#abstractqueuedsynchronizer示例详解二"}},[n._v("#")]),n._v(" # AbstractQueuedSynchronizer示例详解二")]),n._v(" "),s("blockquote",[s("p",[n._v("下面我们结合Condition实现生产者与消费者，来进一步分析AbstractQueuedSynchronizer的内部工作机制。")])]),n._v(" "),s("ul",[s("li",[n._v("Depot(仓库)类")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('import java.util.concurrent.locks.Condition;\nimport java.util.concurrent.locks.Lock;\nimport java.util.concurrent.locks.ReentrantLock;\n\npublic class Depot {\n    private int size;\n    private int capacity;\n    private Lock lock;\n    private Condition fullCondition;\n    private Condition emptyCondition;\n\n    public Depot(int capacity) {\n        this.capacity = capacity;    \n        lock = new ReentrantLock();\n        fullCondition = lock.newCondition();\n        emptyCondition = lock.newCondition();\n    }\n\n    public void produce(int no) {\n        lock.lock();\n        int left = no;\n        try {\n            while (left > 0) {\n                while (size >= capacity)  {\n                    System.out.println(Thread.currentThread() + " before await");\n                    fullCondition.await();\n                    System.out.println(Thread.currentThread() + " after await");\n                }\n                int inc = (left + size) > capacity ? (capacity - size) : left;\n                left -= inc;\n                size += inc;\n                System.out.println("produce = " + inc + ", size = " + size);\n                emptyCondition.signal();\n            }\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        } finally {\n            lock.unlock();\n        }\n    }\n\n    public void consume(int no) {\n        lock.lock();\n        int left = no;\n        try {            \n            while (left > 0) {\n                while (size <= 0) {\n                    System.out.println(Thread.currentThread() + " before await");\n                    emptyCondition.await();\n                    System.out.println(Thread.currentThread() + " after await");\n                }\n                int dec = (size - left) > 0 ? left : size;\n                left -= dec;\n                size -= dec;\n                System.out.println("consume = " + dec + ", size = " + size);\n                fullCondition.signal();\n            }\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        } finally {\n            lock.unlock();\n        }\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br"),s("span",{staticClass:"line-number"},[n._v("59")]),s("br"),s("span",{staticClass:"line-number"},[n._v("60")]),s("br"),s("span",{staticClass:"line-number"},[n._v("61")]),s("br"),s("span",{staticClass:"line-number"},[n._v("62")]),s("br"),s("span",{staticClass:"line-number"},[n._v("63")]),s("br"),s("span",{staticClass:"line-number"},[n._v("64")]),s("br")])]),s("ul",[s("li",[n._v("测试类")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('class Consumer {\n    private Depot depot;\n    public Consumer(Depot depot) {\n        this.depot = depot;\n    }\n\n    public void consume(int no) {\n        new Thread(new Runnable() {\n            @Override\n            public void run() {\n                depot.consume(no);\n            }\n        }, no + " consume thread").start();\n    }\n}\n\nclass Producer {\n    private Depot depot;\n    public Producer(Depot depot) {\n        this.depot = depot;\n    }\n\n    public void produce(int no) {\n        new Thread(new Runnable() {\n\n            @Override\n            public void run() {\n                depot.produce(no);\n            }\n        }, no + " produce thread").start();\n    }\n}\n\npublic class ReentrantLockDemo {\n    public static void main(String[] args) throws InterruptedException {\n        Depot depot = new Depot(500);\n        new Producer(depot).produce(500);\n        new Producer(depot).produce(200);\n        new Consumer(depot).consume(500);\n        new Consumer(depot).consume(200);\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br")])]),s("ul",[s("li",[n._v("运行结果(可能的一种):")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("produce = 500, size = 500\nThread[200 produce thread,5,main] before await\nconsume = 500, size = 0\nThread[200 consume thread,5,main] before await\nThread[200 produce thread,5,main] after await\nproduce = 200, size = 200\nThread[200 consume thread,5,main] after await\nconsume = 200, size = 0\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br")])]),s("blockquote",[s("p",[n._v("说明: 根据结果，我们猜测一种可能的时序如下")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-10.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: p1代表produce 500的那个线程，p2代表produce 200的那个线程，c1代表consume 500的那个线程，c2代表consume 200的那个线程。")])]),n._v(" "),s("ul",[s("li",[n._v("p1线程调用lock.lock，获得锁，继续运行，方法调用顺序在前面已经给出。")]),n._v(" "),s("li",[n._v("p2线程调用lock.lock，由前面的分析可得到如下的最终状态。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-11.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: p2线程调用lock.lock后，会禁止p2线程的继续运行，因为执行了LockSupport.park操作。")])]),n._v(" "),s("ul",[s("li",[n._v("c1线程调用lock.lock，由前面的分析得到如下的最终状态。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-12.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 最终c1线程会在sync queue队列的尾部，并且其结点的前驱结点(包含p2的结点)的waitStatus变为了SIGNAL。")])]),n._v(" "),s("ul",[s("li",[n._v("c2线程调用lock.lock，由前面的分析得到如下的最终状态。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-13.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 最终c1线程会在sync queue队列的尾部，并且其结点的前驱结点(包含c1的结点)的waitStatus变为了SIGNAL。")])]),n._v(" "),s("ul",[s("li",[n._v("p1线程执行emptyCondition.signal，其方法调用顺序如下，只给出了主要的方法调用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-14.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: AQS.CO表示AbstractQueuedSynchronizer.ConditionObject类。此时调用signal方法不会产生任何其他效果。")])]),n._v(" "),s("ul",[s("li",[n._v("p1线程执行lock.unlock，根据前面的分析可知，最终的状态如下。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-15.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 此时，p2线程所在的结点为头节点，并且其他两个线程(c1、c2)依旧被禁止，所以，此时p2线程继续运行，执行用户逻辑。")])]),n._v(" "),s("ul",[s("li",[n._v("p2线程执行fullCondition.await，其方法调用顺序如下，只给出了主要的方法调用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-17-1.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 最终到达的状态是新生成了一个结点，包含了p2线程，此结点在condition queue中；并且sync queue中p2线程被禁止了，因为在执行了LockSupport.park操作。从方法一些调用可知，在await操作中线程会释放锁资源，供其他线程获取。同时，head结点后继结点的包含的线程的许可被释放了，故其可以继续运行。由于此时，只有c1线程可以运行，故运行c1。")])]),n._v(" "),s("ul",[s("li",[n._v("继续运行c1线程，c1线程由于之前被park了，所以此时恢复，继续之前的步骤，即还是执行前面提到的acquireQueued方法，之后，c1判断自己的前驱结点为head，并且可以获取锁资源，最终到达的状态如下。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-16.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 其中，head设置为包含c1线程的结点，c1继续运行。")])]),n._v(" "),s("ul",[s("li",[n._v("c1线程执行fullCondtion.signal，其方法调用顺序如下，只给出了主要的方法调用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-17.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: signal方法达到的最终结果是将包含p2线程的结点从condition queue中转移到sync queue中，之后condition queue为null，之前的尾结点的状态变为SIGNAL。")])]),n._v(" "),s("ul",[s("li",[n._v("c1线程执行lock.unlock操作，根据之前的分析，经历的状态变化如下。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-18.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 最终c2线程会获取锁资源，继续运行用户逻辑。")])]),n._v(" "),s("ul",[s("li",[n._v("c2线程执行emptyCondition.await，由前面的第七步分析，可知最终的状态如下。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-19.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: await操作将会生成一个结点放入condition queue中与之前的一个condition queue是不相同的，并且unpark头节点后面的结点，即包含线程p2的结点。")])]),n._v(" "),s("ul",[s("li",[n._v("p2线程被unpark，故可以继续运行，经过CPU调度后，p2继续运行，之后p2线程在AQS:await方法中被park，继续AQS.CO:await方法的运行，其方法调用顺序如下，只给出了主要的方法调用。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-20.png)")])]),n._v(" "),s("ul",[s("li",[n._v("p2继续运行，执行emptyCondition.signal，根据第九步分析可知，最终到达的状态如下。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-21.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: 最终，将condition queue中的结点转移到sync queue中，并添加至尾部，condition queue会为空，并且将head的状态设置为SIGNAL。")])]),n._v(" "),s("ul",[s("li",[n._v("p2线程执行lock.unlock操作，根据前面的分析可知，最后的到达的状态如下。")])]),n._v(" "),s("blockquote",[s("p",[n._v("![image](./JUC锁_ 锁核心类AQS详解 _ Java 全栈知识体系_files/java-thread-x-juc-aqs-22.png)")])]),n._v(" "),s("blockquote",[s("p",[n._v("说明: unlock操作会释放c2线程的许可，并且将头节点设置为c2线程所在的结点。")])]),n._v(" "),s("ul",[s("li",[s("blockquote",[s("p",[n._v("c2线程继续运行，执行fullCondition. signal，由于此时fullCondition的condition queue已经不存在任何结点了，故其不会产生作用。")])])]),n._v(" "),s("li",[s("blockquote",[s("p",[n._v("c2执行lock.unlock，由于c2是sync队列中最后一个结点，故其不会再调用unparkSuccessor了，直接返回true。即整个流程就完成了。")])])])]),n._v(" "),s("h3",{attrs:{id:"abstractqueuedsynchronizer总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#abstractqueuedsynchronizer总结"}},[n._v("#")]),n._v(" # AbstractQueuedSynchronizer总结")]),n._v(" "),s("blockquote",[s("p",[n._v("对于AbstractQueuedSynchronizer的分析，最核心的就是sync queue的分析。")])]),n._v(" "),s("ul",[s("li",[n._v("每一个结点都是由前一个结点唤醒")]),n._v(" "),s("li",[n._v("当结点发现前驱结点是head并且尝试获取成功，则会轮到该线程运行。")]),n._v(" "),s("li",[n._v("condition queue中的结点向sync queue中转移是通过signal操作完成的。")]),n._v(" "),s("li",[n._v("当结点的状态为SIGNAL时，表示后面的结点需要运行。")])]),n._v(" "),s("h3",{attrs:{id:"参考文章"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[n._v("#")]),n._v(" # 参考文章")]),n._v(" "),s("ul",[s("li",[n._v("文章主要参考自leesf的https://www.cnblogs.com/leesf456/p/5350186.html，在此基础上做了增改。")]),n._v(" "),s("li",[n._v("http://ifeve.com/introduce-abstractqueuedsynchronizer/")]),n._v(" "),s("li",[n._v("http://blog.csdn.net/chen77716/article/details/6641477")]),n._v(" "),s("li",[n._v("https://blog.csdn.net/mulinsen77/article/details/84583716")])])])}),[],!1,null,null,null);s.default=t.exports}}]);